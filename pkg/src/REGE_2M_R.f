! REGE_2M_R.F Ales Ziberna, 2006 - ONEWAY version of REGE (Douglas R. White, 1985)
!  THIS VERSION ALLOWS USER TO SET THE NUMBER OF ITERATIONS 
      subroutine rege2m(R,B1,B2,N,NR,ITER)
      DOUBLE PRECISION   R, B1, B2, DEG1, DEG2, SUM, SUMM1, XMAX1, CMIKJM1
      INTEGER NR, N, ITER, KR, JJ, II
      DIMENSION  N(2)
      DIMENSION  DEG1 (N(1)), DEG2 (N(2)), SUM (N(1),N(2)), R (N(1),N(2), NR), B1 (N(1),N(1)), B2 (N(2),N(2))

!     COMPUTE DEGREE, SUMS FOR I--&gt;K, INITIAL STRUCTURAL EQUIV.
      DO 10 J=1,N(2)
   10 DEG2(J)=0.0      
      DO 100 I=1,N(1)
      DEG1(I)=0.0
      DO 100 J=1,N(2)
      SUM(I,J)=0.0
      DO 50 KR=1,NR
   50 SUM(I,J)=SUM(I,J)+R(I,J,KR)
      DEG2(J)=DEG2(J)+SUM(I,J)
  100 DEG1(I)=DEG1(I)+SUM(I,J)
!      D = 100.0
      
      
!     BEGIN ITERATIONS
      DO 7000 L=1,ITER
!     INITIALIZE DIFFERENCE IN SUCCESSIVE SE MATRICES

!     TAKE POINT I
      DO 520 II = 1, N(1)-1
      I=II
!     TAKE POINT J
      DO 510 JJ= II+1, N(1)
      CM = 0.0
      J=JJ
!     IF DEGREE ZERO NEXT J
      IF(DEG1(J).EQ.0.0) GO TO 506
      I=II
! TAKE EACH OF THE TWO POINTS AS REFERENT
      DO 505 IJ=1,2
      IF (IJ.EQ.1) GOTO 120
      J=II
      I=JJ
!     TAKE POINT K (I--&gt;K, K--&gt;I TO BE EXAMINED)
 120  DO 500 K=1,N(2)
      IF(SUM(I,K).EQ.0.0) GO TO 500
      XMAX1=0.0
!     FIND BEST MATCHING POINT M
      DO 400 M=1,N(2)
      IF(SUM(J,M).EQ.0.0) GO TO 400
      SUMM1=0.0
      DO 300 KR=1,NR      
  300 SUMM1 = SUMM1 +min (R(I,K,KR),r(j,m,kr))
      CMIKJM1 = SUMM1 * b2 (k, m)
!     IF PERFECT MATCH DESIRED, CORRECT MATCH
!     IF(SUMM.NE.SUM(I,K).AND.NOERRS.EQ.1)  CMIKJM=0.0
      IF(CMIKJM1.GT.XMAX1) XMAX1= CMIKJM1
      IF((XMAX1).EQ.SUM(I,K)) GO TO 450
  400 CONTINUE
!     ADD BEST MATCHES TO REGULAR EQUIVALENCE NUMERATOR FOR I,J
  450 CM=CM+XMAX1
  500 CONTINUE
  505 CONTINUE
!     COMPUTE REGULAR EQUIVALENCE
  506 DM = DEG1(II)+DEG1(JJ)
      B1 (II,JJ)= 1.0
      IF(DM.NE.0.0) B1 (II,JJ)=CM/DM
  510  CONTINUE
  520  CONTINUE
  
  
  
!     TAKE POINT I
      DO 1520 II = 1, N(2)-1
      I=II
!     TAKE POINT J
      DO 1510 JJ= II+1, N(2)
      CM = 0.0
      J=JJ
!     IF DEGREE ZERO NEXT J
      IF(DEG2(J).EQ.0.0) GO TO 1506
      I=II
! TAKE EACH OF THE TWO POINTS AS REFERENT
      DO 1505 IJ=1,2
      IF (IJ.EQ.1) GOTO 1120
      J=II
      I=JJ
!     TAKE POINT K (I--&gt;K, K--&gt;I TO BE EXAMINED)
1120  DO 1500 K=1,N(1)
      IF(SUM(K,I).EQ.0.0) GO TO 1500
      XMAX1=0.0
!     FIND BEST MATCHING POINT M
      DO 1400 M=1,N(1)
      IF(SUM(M,J).EQ.0.0) GO TO 1400
      SUMM1=0.0
      DO 1300 KR=1,NR      
 1300 SUMM1 = SUMM1 +min (R(K,I,KR),r(M,J,kr))
      CMIKJM1 = SUMM1 * b1 (max (k,m), min (k,m))
!     IF PERFECT MATCH DESIRED, CORRECT MATCH
!     IF(SUMM.NE.SUM(K,I).AND.NOERRS.EQ.1)  CMIKJM=0.0
      IF(CMIKJM1.GT.XMAX1) XMAX1= CMIKJM1
      IF((XMAX1).EQ.SUM(K,I)) GO TO 1450
 1400 CONTINUE
!     ADD BEST MATCHES TO REGULAR EQUIVALENCE NUMERATOR FOR I,J
 1450 CM=CM+XMAX1
 1500 CONTINUE
 1505 CONTINUE
!     COMPUTE REGULAR EQUIVALENCE
 1506 DM = DEG2(II)+DEG2(JJ)
      B2 (II,JJ)= 1.0
      IF(DM.NE.0.0) B2 (II,JJ)=CM/DM
 1510  CONTINUE
 1520  CONTINUE


! symmetrize : to lower half matrix
      DO 1600 I = 2, N(1)
      DO 1600 J = 1, I-1
  1600 B1(i,j) = B1(j,i) 


! symmetrize : to lower half matrix
      DO 1601 I = 2, N(2)
      DO 1601 J = 1, I-1
 1601 B2(i,j) = B2(j,i) 

  
 7000 CONTINUE

      END
